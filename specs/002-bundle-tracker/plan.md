# Implementation Plan: Community Center Bundle Tracker

**Branch**: `002-bundle-tracker` | **Date**: 2026-02-16 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-bundle-tracker/spec.md`

## Summary

Enhance the existing Bundles tab with comprehensive Community Center bundle tracking. The feature displays all 6 rooms with completion percentages, shows exact items needed per bundle (including quality and OR requirements), highlights items the player already owns in inventory or storage, supports "Available Today" filtering based on season/weather/time/location, and displays notifications when bundle items are collected. Supports both standard and remixed bundles by reading actual save data.

## Technical Context

**Language/Version**: C# targeting .NET 6.0 (required by Stardew Valley / SMAPI)
**Primary Dependencies**: SMAPI (Stardew Modding API), Pathoschild.Stardew.ModBuildConfig NuGet package
**Storage**: N/A — read-only from game state; cached storage inventory invalidates on day-start + inventory changes
**Testing**: xUnit with Moq; tests reference only Core library
**Target Platform**: Windows / Linux / macOS (crossplatform via SMAPI)
**Project Type**: Extension of existing mod (StardewFOMO.Core + StardewFOMO.Mod)
**Performance Goals**: Bundle tab opens instantly; storage scan completes <100ms; no FPS impact
**Constraints**: Storage caching required for performance; scan farmhouse + farm buildings only
**Scale/Scope**: Single-player mod; ~30 bundles across 6 rooms

## Constitution Check

*GATE: All principles already satisfied by existing architecture from feature 001.*

| Principle | Status | How Addressed |
|-----------|--------|---------------|
| I. Game-Decoupled Core | ✅ Pass | All new logic in `StardewFOMO.Core`; interfaces for game data access |
| II. Test-First | ✅ Pass | TDD for all new services; existing test infrastructure |
| III. Thin SMAPI Layer | ✅ Pass | Adapters only translate game data to Core interfaces |
| IV. Observability | ✅ Pass | ILogger already wired through all services |
| V. Simplicity & YAGNI | ✅ Pass | Build on existing IBundleRepository; no new projects |

## Project Structure

### Documentation (this feature)

```text
specs/002-bundle-tracker/
├── plan.md              # This file
├── spec.md              # Feature specification
├── checklists/          # Validation checklists
│   └── requirements.md
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code Changes

Building on existing project structure from feature 001:

```text
src/StardewFOMO.Core/
├── Interfaces/
│   ├── IBundleRepository.cs         # EXTEND: Add GetRoomProgress(), GetBundlesByRoom()
│   ├── IStorageScanner.cs           # NEW: Cache-aware storage scanning interface
│   └── IItemAvailabilityService.cs  # NEW: Determines item availability today
├── Models/
│   ├── BundleInfo.cs                # EXTEND: Add BundleSlot with OR requirements
│   ├── RoomProgress.cs              # NEW: Room-level completion tracking
│   ├── BundleSlot.cs                # NEW: Single slot with multiple valid items
│   ├── OwnedItemInfo.cs             # NEW: Item with location info (inventory vs chest)
│   └── ItemAvailability.cs          # NEW: Availability state (Available, WrongSeason, LocationLocked, etc.)
└── Services/
    ├── BundleProgressService.cs     # NEW: Room/bundle progress calculations
    ├── BundleItemMatcherService.cs  # NEW: Matches owned items to bundle requirements (quality-aware)
    ├── BundleAvailabilityService.cs # NEW: "Available Today" filter logic
    └── BundleNotificationService.cs # NEW: Detects bundle item pickups, deduplicates

src/StardewFOMO.Mod/
├── Adapters/
│   ├── BundleAdapter.cs             # EXTEND: Add room-level methods, remixed bundle support
│   ├── StorageScannerAdapter.cs     # NEW: Scans farmhouse + farm building chests
│   └── ItemAvailabilityAdapter.cs   # NEW: Season/weather/time/location from game state
├── UI/
│   └── PlannerOverlay.cs            # EXTEND: Enhanced DrawBundlesTab with new features
└── ModEntry.cs                      # EXTEND: Wire new services, notification events

tests/StardewFOMO.Core.Tests/
├── Fakes/
│   ├── FakeBundleRepository.cs      # EXTEND: Add room-level methods
│   ├── FakeStorageScanner.cs        # NEW
│   └── FakeItemAvailabilityService.cs # NEW
└── Services/
    ├── BundleProgressServiceTests.cs     # NEW
    ├── StorageScannerServiceTests.cs     # NEW
    ├── BundleItemMatcherServiceTests.cs  # NEW
    ├── BundleAvailabilityServiceTests.cs # NEW
    └── BundleNotificationServiceTests.cs # NEW
```

## Data Model Changes

### Existing Models (to extend)

**BundleInfo** — Add support for bundle slots with multiple valid items:
- Add `IReadOnlyList<BundleSlot> Slots` property
- BundleSlot contains list of acceptable items (OR requirement)

**IBundleRepository** — Add room-level methods:
- `GetRoomProgress(roomName)` → RoomProgress
- `GetAllRooms()` → list of room names
- `IsCommunityComplete()` → bool

### New Models

**RoomProgress**: 
- RoomName, TotalBundles, CompletedBundles, PercentComplete

**BundleSlot**:
- SlotIndex, ValidItems (BundleItem[]), IsFilled, FilledWithItemId

**OwnedItemInfo**:
- ItemId, Quantity, Quality, Location (Inventory/Farmhouse/BuildingName)

**ItemAvailability**:
- ItemId, IsAvailableToday, Reason (Available, WrongSeason, WrongWeather, LocationLocked, WrongTimeOfDay)

## Key Implementation Notes

1. **Remixed Bundles**: Read bundle data directly from `Game1.netWorldState.Value.BundleData` dictionary — handles both standard and remixed configurations dynamically.

2. **Storage Caching**: Cache scanned storage contents on `DayStarted` event and `InventoryChanged` event. Invalidate cache when these events fire.

3. **Quality Matching**: When checking owned items against bundle requirements, verify `item.Quality >= requirement.MinimumQuality`.

4. **OR Requirements**: Bundle slots (like Spring Crops) accept multiple valid items. UI shows all options; ownership check succeeds if player has ANY valid item.

5. **Joja Detection**: Check `Game1.player.hasOrWillReceiveMail("JojaMember")` or examine Community Center building state.

6. **Notification Deduplication**: Track notified item-bundle pairs in a session cache. Only notify on NEW bundle item pickups.

## Dependencies Between User Stories

```
US1 (View Progress) ─────────────────────────┐
                                              │
US2 (Items Needed) ──────────────────────────┼──► US4 (Availability Filter)
                                              │
US3 (Highlight Owned) ───────────────────────┤
                                              │
US5 (Notifications) ◄────────────────────────┘ (depends on item matching logic from US3)

US6 (Joja Route) ─── independent (P3 polish)
```

## GMCM Configuration Additions

Add to existing GMCM registration:
- `EnableBundleNotifications` (bool, default true) — Show notifications on bundle item pickup
- `AvailabilityFilterDefault` (bool, default false) — Whether "Available Today" filter is on by default
