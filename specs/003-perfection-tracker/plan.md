# Implementation Plan: Perfection Tracker

**Branch**: `003-perfection-tracker` | **Date**: 2026-02-16 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/003-perfection-tracker/spec.md`

## Summary

Add a new "Perfection" tab to the mod UI that displays the player's overall perfection percentage and detailed progress across all 10 perfection categories: Shipping, Fish, Cooking, Crafting, Friendship, Monster Slayer, Stardrops, Golden Walnuts, Skills, and Farm Buildings. Each category shows completion percentage, lists missing items grouped by subcategory, highlights items the player owns, and indicates items available "today." Vanilla-only tracking; ignores modded content.

## Technical Context

**Language/Version**: C# targeting .NET 6.0 (required by Stardew Valley / SMAPI)
**Primary Dependencies**: SMAPI (Stardew Modding API), Pathoschild.Stardew.ModBuildConfig NuGet package
**Storage**: N/A — read-only from game state; reuses cached storage from bundle tracker
**Testing**: xUnit with Moq; tests reference only Core library
**Target Platform**: Windows / Linux / macOS (crossplatform via SMAPI)
**Project Type**: Extension of existing mod (StardewFOMO.Core + StardewFOMO.Mod)
**Performance Goals**: Perfection tab opens instantly; data computation <100ms
**Constraints**: Vanilla-only tracking; current player only in multiplayer
**Scale/Scope**: Single-player focus; ~145 shipping items, ~67 fish, ~80 cooking, ~129 crafting, ~34 NPCs, ~12 monster goals, 7 stardrops, 130 walnuts, 5 skills, 5 buildings

## Constitution Check

*GATE: All principles already satisfied by existing architecture from features 001-002.*

| Principle | Status | How Addressed |
|-----------|--------|---------------|
| I. Game-Decoupled Core | ✅ Pass | All new logic in `StardewFOMO.Core`; interfaces for game data access |
| II. Test-First | ✅ Pass | TDD for all new services; existing test infrastructure |
| III. Thin SMAPI Layer | ✅ Pass | Adapters only translate game data to Core interfaces |
| IV. Observability | ✅ Pass | ILogger already wired through all services |
| V. Simplicity & YAGNI | ✅ Pass | Build on existing repositories; no new projects |

## Project Structure

### Documentation (this feature)

```text
specs/003-perfection-tracker/
├── plan.md              # This file
├── spec.md              # Feature specification
├── checklists/          # Validation checklists
│   └── requirements.md
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code Changes

Building on existing project structure from features 001-002:

```text
src/StardewFOMO.Core/
├── Interfaces/
│   ├── IPerfectionRepository.cs     # NEW: Aggregates all perfection data sources
│   ├── IMonsterRepository.cs        # NEW: Monster kill counts
│   ├── IStardropRepository.cs       # NEW: Stardrop collection status
│   ├── IWalnutRepository.cs         # NEW: Golden walnut collection
│   ├── ISkillRepository.cs          # NEW: Player skill levels
│   ├── IBuildingRepository.cs       # NEW: Farm building detection
│   └── IFriendshipRepository.cs     # NEW: NPC friendship levels
├── Models/
│   ├── PerfectionProgress.cs        # NEW: Overall perfection state
│   ├── PerfectionCategory.cs        # NEW: Category-level progress
│   ├── PerfectionItem.cs            # NEW: Individual trackable item
│   ├── ShippingItem.cs              # NEW: Shippable item with subcategory
│   ├── MonsterGoal.cs               # NEW: Monster eradication goal
│   ├── StardropInfo.cs              # NEW: Stardrop with acquisition hint
│   ├── WalnutGroup.cs               # NEW: Walnut acquisition group
│   ├── SkillProgress.cs             # NEW: Skill level tracking
│   ├── FarmBuilding.cs              # NEW: Obelisk/clock status
│   └── FriendshipInfo.cs            # NEW: NPC friendship state
└── Services/
    ├── PerfectionCalculatorService.cs   # NEW: Computes overall perfection %
    ├── ShippingProgressService.cs       # NEW: Shipping collection tracking
    ├── FishProgressService.cs           # NEW: Fish collection tracking
    ├── CookingProgressService.cs        # NEW: Cooking recipe tracking
    ├── CraftingProgressService.cs       # NEW: Crafting recipe tracking
    ├── FriendshipProgressService.cs     # NEW: Friendship tracking
    ├── MonsterProgressService.cs        # NEW: Monster slayer tracking
    ├── StardropProgressService.cs       # NEW: Stardrop tracking
    ├── WalnutProgressService.cs         # NEW: Golden walnut tracking
    ├── SkillProgressService.cs          # NEW: Skill level tracking
    └── BuildingProgressService.cs       # NEW: Farm building tracking

src/StardewFOMO.Mod/
├── Adapters/
│   ├── PerfectionAdapter.cs         # NEW: Aggregates all perfection adapters
│   ├── MonsterAdapter.cs            # NEW: Reads monster kill stats
│   ├── StardropAdapter.cs           # NEW: Reads stardrop mail flags
│   ├── WalnutAdapter.cs             # NEW: Reads golden walnut count
│   ├── SkillAdapter.cs              # NEW: Reads player skill levels
│   ├── BuildingAdapter.cs           # NEW: Scans farm for obelisks/clock
│   └── FriendshipAdapter.cs         # NEW: Reads NPC friendship data
├── UI/
│   └── PlannerOverlay.cs            # EXTEND: Add DrawPerfectionTab method
└── ModEntry.cs                      # EXTEND: Wire new services, add tab

tests/StardewFOMO.Core.Tests/
├── Fakes/
│   ├── FakePerfectionRepository.cs      # NEW
│   ├── FakeMonsterRepository.cs         # NEW
│   ├── FakeStardropRepository.cs        # NEW
│   ├── FakeWalnutRepository.cs          # NEW
│   ├── FakeSkillRepository.cs           # NEW
│   ├── FakeBuildingRepository.cs        # NEW
│   └── FakeFriendshipRepository.cs      # NEW
└── Services/
    ├── PerfectionCalculatorServiceTests.cs  # NEW
    ├── ShippingProgressServiceTests.cs      # NEW
    ├── FishProgressServiceTests.cs          # NEW
    ├── CookingProgressServiceTests.cs       # NEW
    ├── CraftingProgressServiceTests.cs      # NEW
    ├── FriendshipProgressServiceTests.cs    # NEW
    ├── MonsterProgressServiceTests.cs       # NEW
    ├── StardropProgressServiceTests.cs      # NEW
    ├── WalnutProgressServiceTests.cs        # NEW
    ├── SkillProgressServiceTests.cs         # NEW
    └── BuildingProgressServiceTests.cs      # NEW
```

## Data Model

### New Models

**PerfectionProgress**:
- TotalPercentage (computed from all categories)
- Categories: List<PerfectionCategory>
- IsComplete: bool
- GingerIslandUnlocked: bool

**PerfectionCategory**:
- CategoryName (Shipping, Fish, Cooking, etc.)
- CurrentCount, TotalCount
- PercentComplete
- IsComplete: bool
- Subcategories: List<PerfectionSubcategory>
- Weight (contribution to overall %, varies by category)

**PerfectionItem**:
- ItemId, DisplayName
- IsComplete: bool
- IsOwned: bool (player has in inventory/storage)
- IsAvailableToday: bool
- AcquisitionHint: string

**ShippingItem** (extends PerfectionItem):
- Subcategory (Crops, ArtisanGoods, AnimalProducts, Forage, Fish, Minerals, Other)

**MonsterGoal**:
- MonsterCategory (Slimes, VoidSpirits, Bats, etc.)
- CurrentKills, RequiredKills
- SpawnLocations: List<string>

**StardropInfo**:
- Source (Fair, Mine, Museum, Spouse, etc.)
- IsCollected: bool
- AcquisitionHint: string

**WalnutGroup**:
- GroupType (Digging, Puzzles, Fishing, NPCs, Combat, Other)
- CollectedCount, TotalCount

**SkillProgress**:
- SkillName (Farming, Mining, Foraging, Fishing, Combat)
- CurrentLevel, MaxLevel (10)
- XpToNextLevel (if not max)

**FarmBuilding**:
- BuildingType (EarthObelisk, WaterObelisk, DesertObelisk, IslandObelisk, GoldenClock)
- IsBuilt: bool
- Cost: int

**FriendshipInfo**:
- NpcName
- CurrentHearts, MaxHearts
- IsDateable: bool
- IsDating: bool (relevant for max hearts on dateables)

## Key Implementation Notes

1. **Perfection Percentage Calculation** (vanilla formula):
   - Shipping: 15% (for 100% shipping)
   - Fish: 10% (for 100% caught)
   - Cooking: 10% (for 100% cooked)
   - Crafting: 10% (for 100% crafted)
   - Friendship: 11% (for all max hearts)
   - Skills: 2% (for all level 10)
   - Monsters: 10% (for all eradication goals)
   - Stardrops: 2% (for all 7 collected)
   - Walnuts: 5% (for 130 walnuts)
   - Obelisks/Clock: 25% (for all 5 buildings)

2. **Ginger Island Detection**: Check `Game1.MasterPlayer.hasOrWillReceiveMail("Island_Turtle")` for island unlocked status.

3. **Stardrop Detection**: Check mail flags:
   - `gotStardrop_Fair` (Stardew Valley Fair)
   - `gotStardrop_Mine` (100 mine levels)
   - `gotStardrop_Museum` (Museum complete)
   - `gotStardrop_SewerSpouse` (Krobus or spouse)
   - `gotStardrop_MasterAngler` (Master Angler)
   - etc.

4. **Monster Kill Stats**: Read from `Game1.player.stats.specificMonstersKilled` dictionary.

5. **Golden Walnuts**: Read from `Game1.netWorldState.Value.GoldenWalnuts` and `GoldenWalnutsFound`.

6. **Reuse Existing Infrastructure**:
   - ICollectionRepository for shipped items, caught fish, cooked/crafted recipes
   - IFishRepository for fish availability info
   - IRecipeRepository for recipe ingredient info
   - IStorageScanner for "★ [HAVE]" detection
   - IItemAvailabilityService for "Available Today" logic

## Dependencies Between User Stories

```
US1 (Overall Progress) ◄─────────────────────────────────────────────┐
        │                                                             │
        ▼                                                             │
┌───────────────────────────────────────────────────────────────────┐ │
│ US2 (Shipping) ──┬──► US3 (Fish) ──┬──► US4 (Cooking) ──┬──►     │ │
│                  │                  │                    │        │ │
│ US5 (Crafting)◄──┘  US6 (Friends)◄─┘                    ▼        │ │
│                                         ┌─────────────────────┐   │ │
│ US7 (Buildings), US8 (Monsters),        │ US9 (Stardrops)     │   │ │
│ US10 (Walnuts), US11 (Skills)           │ US10 (Walnuts)      │   │ │
│ (can be developed in parallel)          └─────────────────────┘   │ │
└───────────────────────────────────────────────────────────────────┘ │
        │                                                             │
        └─────────────── All feed into ──────────────────────────────┘
```

**Story Groupings**:
- **Foundation (US1)**: Overall progress display - depends on all category services
- **Core Categories (US2-6)**: Shipping, Fish, Cooking, Crafting, Friendship - P1 priorities, can be parallelized
- **Secondary Categories (US7-10)**: Buildings, Monsters, Stardrops, Walnuts - P2 priorities, can be parallelized
- **Polish (US11)**: Skills - simple, low priority

## GMCM Configuration Additions

Add to existing GMCM registration:
- `ShowPerfectionTab` (bool, default true) — Enable/disable Perfection tab visibility
- `PerfectionShowOwnedIndicator` (bool, default true) — Show "★ [HAVE]" on owned items
- `PerfectionShowAvailableToday` (bool, default true) — Highlight items available today
